<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é³´æ½® éŸ³éª¸å³é¸ç”¨ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root { --primary: #ff4b4b; --bg: #f0f2f6; --card-bg: #ffffff; --text: #31333f; --border: #e0e0e0; }
        body { font-family: "Source Sans Pro", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        h1, h2, h3, h4 { margin-top: 0; color: var(--text); }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .tabs { display: flex; overflow-x: auto; border-bottom: 1px solid #ccc; margin-bottom: 20px; gap: 5px; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; white-space: nowrap; }
        .tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .grid-7 { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }

        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
        input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .coe-input { font-size: 0.9em; text-align: center; }
        
        button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.85; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; }
        th, td { padding: 8px; text-align: right; border-bottom: 1px solid #eee; }
        th { text-align: center; background: #f8f9fa; position: sticky; top: 0; }
        .zero-val { color: #d0d0d0; }
        .sum-row { background-color: #e8f0fe; font-weight: bold; border-top: 2px solid #ccc; }

        .msg { padding: 15px; border-radius: 4px; margin-top: 10px; font-weight: bold; text-align: center; }
        .msg.success { background: #d4edda; color: #155724; }
        .msg.warning { background: #fff3cd; color: #856404; }
        .msg.error { background: #f8d7da; color: #721c24; }
        .msg.loading { background: #e2e3e5; color: #383d41; }
        
        .stat-group { margin-bottom: 15px; }
        .stat-header { display: flex; justify-content: space-between; font-size: 0.85em; color: #666; margin-bottom: 5px;}
        .stat-val-disp { font-weight: bold; color: var(--primary); }
        
        details { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; }
        summary { background: #f8f9fa; padding: 10px; cursor: pointer; font-weight: bold; }
        .details-content { padding: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”Š é³´æ½® éŸ³éª¸å³é¸ç”¨ãƒ„ãƒ¼ãƒ«</h1>

    <div class="card">
        <h3>âš™ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ä¿‚æ•°è¨­å®š</h3>
        <div style="margin-bottom: 15px;">
            <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</label>
            <select id="charSelect" onchange="updatePreset()"></select>
        </div>
        
        <p style="font-size:0.85em; color:#666; margin-bottom:5px;">å„ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¹ã‚³ã‚¢ä¿‚æ•°ï¼ˆé‡è¦åº¦ï¼‰ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
        <div class="grid-7" id="coe_inputs"></div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(4, this)">â‘  éŸ³éª¸ã‚¹ã‚³ã‚¢è¨ˆç®—</div>
        <div class="tab" onclick="switchTab(5, this)">â‘¡ ã‚­ãƒ£ãƒ©ã®éŸ³éª¸ç®¡ç†è¡¨</div>
        <div class="tab" onclick="switchTab(1, this)">â‘¢ ç›®æ¨™è¨­å®š</div>
        <div class="tab" onclick="switchTab(2, this)">â‘£ ç¶šè¡Œåˆ¤å®š</div>
        <div class="tab" onclick="switchTab(3, this)">â‘¤ ç¶šè¡Œå¯èƒ½ãƒ©ã‚¤ãƒ³ä¸€è¦§</div>
    </div>

    <div id="tab4" class="tab-content active">
        <div class="card">
            <h3>éŸ³éª¸ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆå˜ä½“ï¼‰</h3>
            <div id="t4_sliders" class="grid-3"></div>
            <hr>
            <div style="text-align:center;">
                <h2>åˆè¨ˆã‚¹ã‚³ã‚¢: <span id="t4_score">0.00</span></h2>
            </div>
        </div>
    </div>

    <div id="tab5" class="tab-content">
        <div class="card">
            <h3>ã‚­ãƒ£ãƒ©ã®éŸ³éª¸ç®¡ç†è¡¨</h3>
            <div style="margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                <label>ã‚³ã‚¹ãƒˆæ§‹æˆé¸æŠ</label>
                <select id="costPatternSelect" onchange="updateCostPattern()">
                    <option value="43311">4-3-3-1-1 (ä¸»æµ)</option>
                    <option value="44111">4-4-1-1-1 (ã‚«ãƒ«ãƒ†ã‚¸ã‚¢ç­‰)</option>
                </select>
            </div>
            <div id="t5_container"></div>
            <button onclick="calcEcho5()">é›†è¨ˆã™ã‚‹</button>
        </div>
        <div class="card">
            <h3>é›†è¨ˆçµæœ</h3>
            <button onclick="downloadEcho5CSV()" style="margin-bottom:15px; background:#28a745;">çµæœã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <div style="overflow-x:auto;">
                <table id="t5_table"></table>
            </div>
        </div>
    </div>

    <div id="tab1" class="tab-content">
        <div class="grid-2">
            <div class="card">
                <h3>ç›®æ¨™ã‚¹ã‚³ã‚¢è¨ˆç®—</h3>
                <p style="font-size:0.9em; color:#666;">ä½¿ç”¨å¯èƒ½ãªãƒãƒ¥ãƒŠã®é‡ã‹ã‚‰ç¾å®Ÿçš„ãªç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã€ç´ æã®æ¶ˆè²»é‡ã¨åˆã‚ã›ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                <label>ä½¿ç”¨å¯èƒ½ãƒãƒ¥ãƒŠ: <input type="number" id="t1_limit" value="500" step="100"></label>
                <button onclick="calcTarget()">ç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—</button>
            </div>
            <div class="card">
                <h3>ç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’ç›´æ¥å…¥åŠ›</h3>
                <p style="font-size:0.9em; color:#666;">å…¥åŠ›ã•ã‚ŒãŸç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒãƒ¥ãƒŠã€ãƒ¬ã‚³ãƒ¼ãƒ‰ã€éŸ³éª¸ç´ ä½“ã®æ¶ˆè²»é‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
                <label>ç›®æ¨™ã‚¹ã‚³ã‚¢: <input type="number" id="t1_score" value="40"></label>
                <button onclick="calcResources()">ç´ ææ¶ˆè²»é‡ã‚’è¨ˆç®—</button>
            </div>
        </div>
        
        <div id="t1_loading" class="msg loading" style="display:none;">
            â³ è¨ˆç®—ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
        </div>

        <div id="t1_result_area" style="display:none;">
            <div class="msg success" id="t1_msg"></div>
            <div class="card">
                <h3>ğŸ“Š ç´ ææ¶ˆè²»é‡ï¼ˆæœŸå¾…å€¤ï¼‰</h3>
                <div class="grid-3" style="text-align: center;">
                    <div><h4>ãƒãƒ¥ãƒŠ</h4><span id="res_tuner" style="font-size: 1.5em; font-weight: bold;">-</span></div>
                    <div>
                        <h4>ãƒ¬ã‚³ãƒ¼ãƒ‰ (é‡‘)</h4>
                        <span id="res_record" style="font-size: 1.5em; font-weight: bold;">-</span>
                        <div style="font-size:0.8em; color:#666;">(é‡‘ãƒ¬ã‚³ãƒ¼ãƒ‰æ›ç®—Ã·5000)</div>
                    </div>
                    <div><h4>éŸ³éª¸ç´ ä½“</h4><span id="res_body" style="font-size: 1.5em; font-weight: bold;">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab2" class="tab-content">
        <div class="grid-2">
            <div class="card">
                <h3>ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¥åŠ›</h3>
                <div class="stat-group">
                    <div class="stat-header">
                        <label>ç¾åœ¨ã®å¼·åŒ–å›æ•°</label>
                        <span id="t2_times_val" class="stat-val-disp">1</span>
                    </div>
                    <input type="range" id="t2_times" min="0" max="4" value="1" oninput="document.getElementById('t2_times_val').innerText=this.value">
                </div>
                <hr>
                <div id="t2_sliders"></div>
            </div>
            <div class="card">
                <h3>åˆ¤å®šçµæœ</h3>
                <div style="text-align:center; margin-bottom:20px;">
                    ç¾åœ¨ã®ã‚¹ã‚³ã‚¢: <span id="t2_current_score" style="font-size:1.5em; font-weight:bold;">0.00</span>
                </div>
                <button onclick="judgeContinue()">åˆ¤å®šå®Ÿè¡Œ</button>
                <div id="t2_result_msg" class="msg" style="display:none;"></div>
                <div id="t2_detail" style="margin-top:15px; font-size:0.95em; line-height:1.5;"></div>
            </div>
        </div>
    </div>

    <div id="tab3" class="tab-content">
        <div class="card">
            <h3>ç¶šè¡Œå¯èƒ½æœ€å°ãƒ©ã‚¤ãƒ³ä¸€è¦§</h3>
            <div class="grid-2" style="align-items: end;">
                <label>æ¤œç´¢ã™ã‚‹å¼·åŒ–å›æ•°
                    <select id="t3_times">
                        <option value="1">1å›ç›®</option>
                        <option value="2">2å›ç›®</option>
                        <option value="3">3å›ç›®</option>
                        <option value="4">4å›ç›®</option>
                    </select>
                </label>
                <button onclick="calcLines()">ä¸€è¦§ã‚’ç”Ÿæˆ</button>
            </div>
            <div id="t3_loading" class="msg loading" style="display:none;">
                â³ è¨ˆç®—ä¸­... (ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­ã¯1åˆ†ç¨‹åº¦ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)
            </div>
            <div style="margin-top:20px; overflow-x:auto;">
                <table id="t3_table"></table>
            </div>
        </div>
    </div>

</div>

<script>
    // ============================================
    // 1. è¨­å®š & å®šæ•°
    // ============================================
    
    // â˜…Hugging Faceã®URLã‚’æŒ‡å®š (æœ«å°¾ã® / ã¯ç„¡ã—)
    const API_BASE = "https://okuson-chuna-backend.hf.space";

    const SUBST_DATA = {
        "cr": [6.3, 6.9, 7.5, 8.1, 8.7, 9.3, 9.9, 10.5],
        "cd": [12.6, 13.8, 15.0, 16.2, 17.4, 18.6, 19.8, 21.0],
        "atk_p": [6.4, 7.1, 7.9, 8.6, 9.4, 10.1, 10.9, 11.6],
        "dam": [6.4, 7.1, 7.9, 8.6, 9.4, 10.1, 10.9, 11.6],
        "er": [6.8, 7.6, 8.4, 9.2, 10.0, 10.8, 11.6, 12.4],
        "atk_n": [30, 40, 50, 60],
        "hp_n": [320, 360, 390, 430, 470, 510, 540, 580]
    };

    const PRESETS = {
        "ã‚«ã‚¹ã‚¿ãƒ  (æ‰‹å‹•è¨­å®š)": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—1", "d2": "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—2"},
        "ãƒªãƒ³ãƒãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "åƒå’²": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ä»‡é ": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚¬ãƒ«ãƒ–ãƒ¬ãƒ¼ãƒŠ": {"coe": [2.0, 1.0, 1.0, 0.3, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ¦ãƒ¼ãƒ": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚ªãƒ¼ã‚¬ã‚¹ã‚¿": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ•ãƒ­ãƒ¼ãƒ´ã‚¡": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 0.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ«ãƒ‘": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚«ãƒ«ãƒ†ã‚¸ã‚¢": {"coe": [2.0, 1.0, 0.8, 0.3, 0.3, 1.0, 0.005], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "è§£æ”¾ãƒ€ãƒ¡", "is_hp": true},
        "ã‚·ãƒ£ã‚³ãƒ³ãƒŒ": {"coe": [2.0, 1.0, 1.0, 0.3, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚¶ãƒ³ãƒ‹ãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚«ãƒ³ã‚¿ãƒ¬ãƒ©": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ–ãƒ©ãƒ³ãƒˆ": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ•ã‚£ãƒ¼ãƒ“ãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ­ã‚³ã‚³": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚«ãƒ«ãƒ­ãƒƒã‚¿": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ„ãƒã‚­": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æŠ˜æ": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ç›¸é‡Œè¦": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "é•·é›¢": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ä»Šæ±": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 0.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "åŸéœ–": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "å¿Œç‚": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æ°—é“ä¸»äººå…¬": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æ¶ˆæ»…ä¸»äººå…¬": {"coe": [2.0, 1.0, 1.0, 0.3, 0.3, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "è§£æ”¾ãƒ€ãƒ¡"},
        "å›æŠ˜ä¸»äººå…¬": {"coe": [2.0, 1.0, 1.0, 0.4, 0.3, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "è§£æ”¾ãƒ€ãƒ¡"},
        "ã‚¢ãƒ³ã‚³": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚«ã‚«ãƒ­": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "å‡Œé™½": {"coe": [2.0, 1.0, 1.0, 0.3, 0.3, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡"},
        "ç¯ç¯": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚¢ãƒ¼ãƒ«ãƒˆ": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ç†¾éœ": {"coe": [2.0, 1.0, 1.0, 0.5, 0.3, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "è§£æ”¾ãƒ€ãƒ¡"},
        "ãƒ¢ãƒ«ãƒˆãƒ•ã‚£ãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ä¸¹ç‘¾": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æ•£è¯": {"coe": [2.0, 1.0, 1.0, 0.3, 0.3, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡"}
    };

    const COST_PATTERNS = {
        "43311": ["ã‚³ã‚¹ãƒˆ4", "ã‚³ã‚¹ãƒˆ3(A)", "ã‚³ã‚¹ãƒˆ3(B)", "ã‚³ã‚¹ãƒˆ1(A)", "ã‚³ã‚¹ãƒˆ1(B)"],
        "44111": ["ã‚³ã‚¹ãƒˆ4(A)", "ã‚³ã‚¹ãƒˆ4(B)", "ã‚³ã‚¹ãƒˆ1(A)", "ã‚³ã‚¹ãƒˆ1(B)", "ã‚³ã‚¹ãƒˆ1(C)"]
    };

    let state = {
        target_score: 40,
        ave_chuna: 500.0,
        preset: PRESETS["ã‚«ã‚¹ã‚¿ãƒ  (æ‰‹å‹•è¨­å®š)"],
        coe_override: [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1],
        is_hp: false,
        cost_pattern: "43311"
    };

    // ============================================
    // 2. UIæ“ä½œ
    // ============================================
    window.onload = function() {
        initCharSelect();
        updatePreset();
    };

    function switchTab(n, btnElement) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab${n}`).classList.add('active');
    }

    function initCharSelect() {
        const sel = document.getElementById('charSelect');
        Object.keys(PRESETS).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            sel.appendChild(opt);
        });
    }

    function updatePreset() {
        const name = document.getElementById('charSelect').value;
        state.preset = PRESETS[name];
        state.coe_override = [...state.preset.coe];
        state.is_hp = !!state.preset.is_hp;
        
        renderCoeInputs();
        renderAllSliders();
    }

    function updateCostPattern() {
        state.cost_pattern = document.getElementById('costPatternSelect').value;
        renderAllSliders();
        document.getElementById('t5_table').innerHTML = ""; // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
    }

    function renderCoeInputs() {
        const container = document.getElementById('coe_inputs');
        container.innerHTML = "";
        const labels = getLabels(true);
        
        labels.forEach((lbl, i) => {
            const div = document.createElement('div');
            const label = document.createElement('label');
            label.style.fontSize = "0.75em";
            label.innerText = lbl;
            
            const input = document.createElement('input');
            input.type = "number";
            input.step = "0.1";
            input.className = "coe-input";
            input.value = state.coe_override[i];
            input.onchange = (e) => {
                state.coe_override[i] = parseFloat(e.target.value);
                renderAllSliders();
                recalcLocalScore();
            };
            
            div.appendChild(label);
            div.appendChild(input);
            container.appendChild(div);
        });
    }

    function getLabels(useStatic = false) {
        const p = state.preset;
        const atk_p_lbl = state.is_hp ? "HP%" : "æ”»æ’ƒ%";
        const atk_p_full = state.is_hp ? "HPï¼…" : "æ”»æ’ƒåŠ›ï¼…";
        const flat_lbl = state.is_hp ? "HPå®Ÿæ•°" : "æ”»æ’ƒå®Ÿæ•°";

        if(useStatic) return ["ã‚¯ãƒªç‡", "ã‚¯ãƒªãƒ€ãƒ¡", atk_p_lbl, p.d1 || "ãƒ€ãƒ¡1", p.d2 || "ãƒ€ãƒ¡2", "å…±é³´åŠ¹ç‡", flat_lbl];
        return ["ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«", "ã‚¯ãƒªãƒ€ãƒ¡", atk_p_full, p.d1 || "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—1", p.d2 || "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—2", "å…±é³´åŠ¹ç‡", flat_lbl];
    }

    function getValuesList(index) {
        if (index === 2) return state.is_hp ? SUBST_DATA.atk_p : SUBST_DATA.atk_p; 
        if (index === 6) return state.is_hp ? SUBST_DATA.hp_n : SUBST_DATA.atk_n; 
        const map = [
            SUBST_DATA.cr, SUBST_DATA.cd, SUBST_DATA.atk_p, 
            SUBST_DATA.dam, SUBST_DATA.dam, SUBST_DATA.er, 
            SUBST_DATA.atk_n 
        ];
        return map[index];
    }

    function createSliderHTML(id, label, values) {
        const onInput = `
            const v = this.value;
            const vals = [${values.join(',')}];
            const disp = document.getElementById('${id}_disp');
            if(v==0) { disp.innerText='æœªå–å¾—'; disp.style.color='#999'; }
            else { disp.innerText=vals[v-1]; disp.style.color='var(--primary)'; }
            recalcLocalScore();
        `;
        
        return `
            <div class="stat-group">
                <div class="stat-header">
                    <label>${label}</label>
                    <span id="${id}_disp" class="stat-val-disp" style="color:#999;">æœªå–å¾—</span>
                </div>
                <input type="range" id="${id}" min="0" max="${values.length}" value="0" step="1" oninput="${onInput.replace(/\n/g,' ')}">
            </div>
        `;
    }

    function renderAllSliders() {
        const labels = getLabels();
        const coe = state.coe_override;

        // Tab 2 & 4 (Single Echo)
        let t2_html = "", t4_html = "";
        labels.forEach((lbl, i) => {
            if (coe[i] > 0) {
                const vals = getValuesList(i);
                t2_html += createSliderHTML(`t2_sub_${i}`, lbl, vals);
                t4_html += createSliderHTML(`t4_sub_${i}`, lbl, vals);
            }
        });
        document.getElementById('t2_sliders').innerHTML = `<div class="grid-3">${t2_html}</div>`;
        document.getElementById('t4_sliders').innerHTML = t4_html;

        // Tab 5 (Character Management)
        const echoes = COST_PATTERNS[state.cost_pattern];
        let t5_html = "";
        echoes.forEach((eName, eIdx) => {
            let content = "";
            labels.forEach((lbl, i) => {
                if (coe[i] > 0) content += createSliderHTML(`t5_${eIdx}_${i}`, lbl, getValuesList(i));
            });
            t5_html += `<details><summary>${eName}</summary><div class="details-content grid-3">${content}</div></details>`;
        });
        document.getElementById('t5_container').innerHTML = t5_html;
    }

    function getSliderValue(id, valueIndex) {
        if (valueIndex == 0) return 0;
        const parts = id.split('_'); 
        const typeIdx = parseInt(parts[2]); 
        const list = getValuesList(typeIdx);
        return list[valueIndex - 1];
    }

    function recalcLocalScore() {
        const coe = state.coe_override;
        let s2 = 0, s4 = 0;
        for(let i=0; i<7; i++) {
            if(coe[i]>0) {
                const el2 = document.getElementById(`t2_sub_${i}`);
                if(el2) s2 += getSliderValue(el2.id, parseInt(el2.value)) * coe[i];
                
                const el4 = document.getElementById(`t4_sub_${i}`);
                if(el4) s4 += getSliderValue(el4.id, parseInt(el4.value)) * coe[i];
            }
        }
        document.getElementById('t2_current_score').innerText = s2.toFixed(2);
        document.getElementById('t4_score').innerText = s4.toFixed(2);
    }

    function showTargetResult(data) {
        const area = document.getElementById('t1_result_area');
        area.style.display = 'block';
        document.getElementById('t1_msg').innerText = `ç›®æ¨™ã‚¹ã‚³ã‚¢: ${data.target_score}`;
        document.getElementById('res_tuner').innerText = Math.round(data.ave_chuna).toLocaleString();
        
        const recNum = Math.round(data.res_record / 5000);
        document.getElementById('res_record').innerText = recNum.toLocaleString();
        
        document.getElementById('res_body').innerText = (data.res_body > 10000) ? 'âˆ' : Math.round(data.res_body);
    }

    // ============================================
    // 3. APIé€šä¿¡
    // ============================================

    async function calcTarget() {
        const limit = document.getElementById('t1_limit').value;
        const btn = document.querySelector('button[onclick="calcTarget()"]');
        const loading = document.getElementById('t1_loading');
        
        btn.disabled = true; 
        loading.style.display = 'block';
        document.getElementById('t1_result_area').style.display = 'none';

        try {
            const res = await fetch(`${API_BASE}/api/calc_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chuna_limit: parseFloat(limit), coe: state.coe_override, is_hp: state.is_hp })
            });
            if(!res.ok) throw new Error();
            const data = await res.json();
            
            state.target_score = data.target_score;
            state.ave_chuna = data.ave_chuna;
            document.getElementById('t1_score').value = data.target_score;
            showTargetResult(data);
        } catch(e) { alert("APIã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
        finally { btn.disabled = false; loading.style.display = 'none'; }
    }

    async function calcResources() {
        const score = document.getElementById('t1_score').value;
        const btn = document.querySelector('button[onclick="calcResources()"]');
        const loading = document.getElementById('t1_loading');

        btn.disabled = true;
        loading.style.display = 'block';
        document.getElementById('t1_result_area').style.display = 'none';

        try {
            const res = await fetch(`${API_BASE}/api/calc_resources`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ target_score: parseInt(score), coe: state.coe_override, is_hp: state.is_hp })
            });
            if(!res.ok) throw new Error();
            const data = await res.json();
            state.target_score = data.target_score;
            state.ave_chuna = data.ave_chuna;
            showTargetResult(data);
        } catch(e) { alert("APIã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
        finally { btn.disabled = false; loading.style.display = 'none'; }
    }

    async function judgeContinue() {
        const times = document.getElementById('t2_times').value;
        let sub = [];
        for(let i=0; i<7; i++) {
            const el = document.getElementById(`t2_sub_${i}`);
            const val = getSliderValue(`t2_sub_${i}`, parseInt(el ? el.value : 0));
            sub.push(val);
        }

        try {
            const res = await fetch(`${API_BASE}/api/judge`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_score: parseInt(state.target_score),
                    current_times: parseInt(times),
                    substatus: sub,
                    ave_chuna: state.ave_chuna,
                    coe: state.coe_override,
                    is_hp: state.is_hp
                })
            });
            const data = await res.json();
            const msgEl = document.getElementById('t2_result_msg');
            const detEl = document.getElementById('t2_detail');
            msgEl.style.display = 'block';
            msgEl.innerText = data.judgment;
            msgEl.className = 'msg ' + (data.judgment === "å¼·åŒ–æ¨å¥¨" ? "success" : data.judgment.includes("å¯èƒ½") ? "warning" : "error");

            if (data.expected_cost < 1000000) {
                const diff = state.ave_chuna - data.expected_cost;
                let comment = diff >= 0 ? `(ãƒ¬ãƒ™ãƒ«0ã‹ã‚‰ã®å¼·åŒ–ã‚ˆã‚Š ${diff.toFixed(1)} ãƒãƒ¥ãƒŠãŠå¾—)` : `(ãƒ¬ãƒ™ãƒ«0ã‹ã‚‰ã®å¼·åŒ–ã‚ˆã‚Š ${Math.abs(diff).toFixed(1)} ãƒãƒ¥ãƒŠæ)`;
                detEl.innerHTML = `ã‚´ãƒ¼ãƒ«ã¾ã§ã®æœŸå¾…ã‚³ã‚¹ãƒˆ: <b>${Math.round(data.expected_cost)}</b> ãƒãƒ¥ãƒŠ<br>${comment}`;
            } else { detEl.innerText = ""; }
        } catch(e) { alert("APIã‚¨ãƒ©ãƒ¼"); }
    }

    async function calcLines() {
        const times = document.getElementById('t3_times').value;
        const loader = document.getElementById('t3_loading');
        loader.style.display = 'block';
        document.getElementById('t3_table').innerHTML = "";

        try {
            const res = await fetch(`${API_BASE}/api/lines`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_score: parseInt(state.target_score),
                    search_times: parseInt(times),
                    ave_chuna: state.ave_chuna,
                    coe: state.coe_override,
                    is_hp: state.is_hp
                })
            });
            const data = await res.json();
            loader.style.display = 'none';
            renderLineTable(data.results);
        } catch(e) { loader.style.display = 'none'; alert("APIã‚¨ãƒ©ãƒ¼"); }
    }

    function renderLineTable(rows) {
        const table = document.getElementById('t3_table');
        const labels = getLabels();
        const coe = state.coe_override;
        
        if (!rows || rows.length === 0) { table.innerHTML = "<tr><td>æ¡ä»¶ã‚’æº€ãŸã™çµ„ã¿åˆã‚ã›ãªã—</td></tr>"; return; }

        let head = "<tr>";
        labels.forEach((l, i) => { if(coe[i]>0) head += `<th>${l}</th>`; });
        head += "<th>ã‚¹ã‚³ã‚¢</th><th>ãƒãƒ¥ãƒŠ</th></tr>";
        
        rows.sort((a,b) => {
            const countA = a.substatus.filter(v => v > 0).length;
            const countB = b.substatus.filter(v => v > 0).length;
            if (countA !== countB) return countA - countB;
            return b.score - a.score;
        });

        let body = "";
        rows.forEach(r => {
            let tr = "<tr>";
            r.substatus.forEach((val, i) => {
                if(coe[i]>0) tr += `<td class="${val===0?'zero-val':''}">${val.toFixed(1)}</td>`;
            });
            tr += `<td>${r.score.toFixed(1)}</td><td>${Math.round(r.chuna)}</td></tr>`;
            body += tr;
        });
        table.innerHTML = `<thead>${head}</thead><tbody>${body}</tbody>`;
    }

    function downloadEcho5CSV() {
        const labels = getLabels();
        const coe = state.coe_override;
        const echoes = COST_PATTERNS[state.cost_pattern];
        let csv = "é …ç›®," + echoes.join(",") + ",åˆè¨ˆ\n";

        let totalStats = Array(7).fill(0);
        let scoreInc = Array(5).fill(0);
        let scoreExc = Array(5).fill(0);
        let totalScoreInc = 0;
        let totalScoreExc = 0;

        for(let e=0; e<5; e++) {
            let rowScore = 0;
            let erVal = 0;
            for(let i=0; i<7; i++) {
                if(coe[i]>0) {
                    const el = document.getElementById(`t5_${e}_${i}`);
                    const val = getSliderValue(`t5_${e}_${i}`, parseInt(el ? el.value : 0));
                    totalStats[i] += val;
                    rowScore += val * coe[i];
                    if(i === 5) erVal = val;
                }
            }
            scoreInc[e] = rowScore;
            scoreExc[e] = rowScore - (erVal * coe[5]);
            totalScoreInc += scoreInc[e];
            totalScoreExc += scoreExc[e];
        }

        labels.forEach((lbl, i) => {
            if(coe[i]>0) {
                let row = [lbl];
                for(let e=0; e<5; e++) {
                    const el = document.getElementById(`t5_${e}_${i}`);
                    const val = getSliderValue(`t5_${e}_${i}`, parseInt(el ? el.value : 0));
                    row.push(val);
                }
                row.push(totalStats[i].toFixed(1));
                csv += row.join(",") + "\n";
            }
        });

        csv += "å€‹åˆ¥ã‚¹ã‚³ã‚¢(è¾¼)," + scoreInc.map(s=>s.toFixed(1)).join(",") + ",-\n";
        csv += "å€‹åˆ¥ã‚¹ã‚³ã‚¢(æŠœ)," + scoreExc.map(s=>s.toFixed(1)).join(",") + ",-\n";
        csv += `å…¨ä½“ã‚¹ã‚³ã‚¢(è¾¼),,,,,${totalScoreInc.toFixed(1)}\n`;
        csv += `å…¨ä½“ã‚¹ã‚³ã‚¢(æŠœ),,,,,${totalScoreExc.toFixed(1)}\n`;

        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: "text/csv"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "echo_5_set.csv";
        link.click();
    }

    function calcEcho5() {
        const labels = getLabels();
        const coe = state.coe_override;
        const echoes = COST_PATTERNS[state.cost_pattern];
        
        let totalStats = Array(7).fill(0);
        let totalScoreInc = 0;
        let totalScoreExc = 0;
        
        let scoreInc = Array(5).fill(0); 
        let scoreExc = Array(5).fill(0); 

        for(let e=0; e<5; e++) {
            let rowScore = 0;
            let erVal = 0;
            for(let i=0; i<7; i++) {
                if(coe[i]>0) {
                    const el = document.getElementById(`t5_${e}_${i}`);
                    const val = getSliderValue(`t5_${e}_${i}`, parseInt(el ? el.value : 0));
                    totalStats[i] += val;
                    rowScore += val * coe[i];
                    if(i === 5) erVal = val;
                }
            }
            scoreInc[e] = rowScore;
            scoreExc[e] = rowScore - (erVal * coe[5]);
            
            totalScoreInc += scoreInc[e];
            totalScoreExc += scoreExc[e];
        }

        let html = `<thead><tr><th>é …ç›®</th>`;
        echoes.forEach(e => html += `<th>${e}</th>`);
        html += `<th>åˆè¨ˆ</th></tr></thead><tbody>`;

        labels.forEach((lbl, i) => {
            if(coe[i]>0) {
                html += `<tr><td>${lbl}</td>`;
                for(let e=0; e<5; e++) {
                    const el = document.getElementById(`t5_${e}_${i}`);
                    const val = getSliderValue(`t5_${e}_${i}`, parseInt(el ? el.value : 0));
                    html += `<td class="${val==0?'zero-val':''}">${val}</td>`;
                }
                html += `<td><b>${totalStats[i].toFixed(1)}</b></td></tr>`;
            }
        });
        
        html += `<tr class="sum-row"><td>å€‹åˆ¥(è¾¼)</td>`;
        echoes.forEach((_, e) => html += `<td>${scoreInc[e].toFixed(1)}</td>`);
        html += `<td>-</td></tr>`;

        html += `<tr class="sum-row" style="background:#f9f9f9;"><td>å€‹åˆ¥(æŠœ)</td>`;
        echoes.forEach((_, e) => html += `<td>${scoreExc[e].toFixed(1)}</td>`);
        html += `<td>-</td></tr>`;

        html += `<tr style="background:#f0f0f0; border-top:2px solid #333;"><td><b>å…¨ä½“(è¾¼)</b></td><td colspan="5" style="text-align:center;"></td><td><b>${totalScoreInc.toFixed(1)}</b></td></tr>`;
        html += `<tr style="background:#f0f0f0;"><td><b>å…¨ä½“(æŠœ)</b></td><td colspan="5" style="font-size:0.8em; text-align:center;">(å…±é³´åŠ¹ç‡ã‚’é™¤ã)</td><td><b>${totalScoreExc.toFixed(1)}</b></td></tr>`;
        
        html += `</tbody>`;
        document.getElementById('t5_table').innerHTML = html;
    }
</script>

</body>
</html>