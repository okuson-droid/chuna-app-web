<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é³´æ½® éŸ³éª¸å³é¸ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root { --primary: #ff4b4b; --bg: #f0f2f6; --card-bg: #ffffff; --text: #31333f; --border: #e0e0e0; }
        body { font-family: "Source Sans Pro", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        h1, h2, h3, h4 { margin-top: 0; color: var(--text); }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .tabs { display: flex; overflow-x: auto; border-bottom: 1px solid #ccc; margin-bottom: 20px; gap: 5px; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; white-space: nowrap; }
        .tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        /* ä¿‚æ•°è¨­å®šç”¨ã®ã‚°ãƒªãƒƒãƒ‰ï¼ˆ7åˆ—ï¼‰ */
        .grid-7 { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }

        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
        input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        input[type="range"] { width: 100%; }
        /* ä¿‚æ•°å…¥åŠ›ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .coe-input { font-size: 0.9em; text-align: center; }
        
        button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.85; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; }
        th, td { padding: 8px; text-align: right; border-bottom: 1px solid #eee; }
        th { text-align: center; background: #f8f9fa; position: sticky; top: 0; }
        .zero-val { color: #d0d0d0; }
        .sum-row { background-color: #e8f0fe; font-weight: bold; border-top: 2px solid #ccc; }

        .msg { padding: 15px; border-radius: 4px; margin-top: 10px; font-weight: bold; text-align: center; }
        .msg.success { background: #d4edda; color: #155724; }
        .msg.warning { background: #fff3cd; color: #856404; }
        .msg.error { background: #f8d7da; color: #721c24; }
        .msg.loading { background: #e2e3e5; color: #383d41; }
        
        .stat-group { margin-bottom: 10px; }
        .stat-label { font-size: 0.85em; color: #666; }
        
        details { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; }
        summary { background: #f8f9fa; padding: 10px; cursor: pointer; font-weight: bold; }
        .details-content { padding: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”Š é³´æ½® éŸ³éª¸å³é¸ãƒ„ãƒ¼ãƒ« (Client)</h1>

    <div class="card">
        <h3>âš™ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ä¿‚æ•°è¨­å®š</h3>
        <div style="margin-bottom: 15px;">
            <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</label>
            <select id="charSelect" onchange="updatePreset()"></select>
        </div>
        
        <p style="font-size:0.85em; color:#666; margin-bottom:5px;">å„ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¹ã‚³ã‚¢ä¿‚æ•°ï¼ˆé‡è¦åº¦ï¼‰ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
        <div class="grid-7" id="coe_inputs">
            </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(1)">â‘  ç›®æ¨™è¨­å®š</div>
        <div class="tab" onclick="switchTab(2)">â‘¡ ç¶šè¡Œåˆ¤å®š</div>
        <div class="tab" onclick="switchTab(3)">â‘¢ æœ€å°ãƒ©ã‚¤ãƒ³</div>
        <div class="tab" onclick="switchTab(4)">â‘£ å˜ä½“ã‚¹ã‚³ã‚¢</div>
        <div class="tab" onclick="switchTab(5)">â‘¤ 5é€£ç®¡ç†</div>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="grid-2">
            <div class="card">
                <h3>ç›®æ¨™ã‚¹ã‚³ã‚¢ç®—å‡º</h3>
                <p style="font-size:0.9em; color:#666;">ã‚³ã‚¹ãƒˆã‹ã‚‰ç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’é€†ç®—ã—ã¾ã™ã€‚</p>
                <label>ä½¿ç”¨å¯èƒ½ãƒãƒ¥ãƒŠä¸Šé™: <input type="number" id="t1_limit" value="500" step="100"></label>
                <button onclick="calcTarget()">ç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—</button>
            </div>
            <div class="card">
                <h3>å¿…è¦ç´ æè¨ˆç®—</h3>
                <p style="font-size:0.9em; color:#666;">ç›®æ¨™ã‚¹ã‚³ã‚¢ã‹ã‚‰ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
                <label>ç›®æ¨™ã‚¹ã‚³ã‚¢: <input type="number" id="t1_score" value="25"></label>
                <button onclick="calcResources()">ç´ ææ¶ˆè²»é‡ã‚’è¨ˆç®—</button>
            </div>
        </div>
        
        <div id="t1_result_area" style="display:none;">
            <div class="msg success" id="t1_msg"></div>
            <div class="card">
                <h3>ğŸ“Š ç´ ææ¶ˆè²»é‡ï¼ˆæœŸå¾…å€¤ï¼‰</h3>
                <div class="grid-3" style="text-align: center;">
                    <div><h4>ãƒãƒ¥ãƒŠ</h4><span id="res_tuner" style="font-size: 1.5em; font-weight: bold;">-</span></div>
                    <div>
                        <h4>ãƒ¬ã‚³ãƒ¼ãƒ‰ (é‡‘)</h4>
                        <span id="res_record" style="font-size: 1.5em; font-weight: bold;">-</span>
                        <div style="font-size:0.8em; color:#666;">(é‡‘ãƒ¬ã‚³ãƒ¼ãƒ‰æ›ç®—Ã·5000)</div>
                    </div>
                    <div><h4>éŸ³éª¸ç´ ä½“</h4><span id="res_body" style="font-size: 1.5em; font-weight: bold;">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab2" class="tab-content">
        <div class="grid-2">
            <div class="card">
                <h3>ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¥åŠ›</h3>
                <label>ç¾åœ¨ã®å¼·åŒ–å›æ•°: <span id="t2_times_val" style="font-weight:bold; color:var(--primary);">1</span>
                    <input type="range" id="t2_times" min="0" max="4" value="1" oninput="document.getElementById('t2_times_val').innerText=this.value">
                </label>
                <hr>
                <div id="t2_sliders"></div>
            </div>
            <div class="card">
                <h3>åˆ¤å®šçµæœ</h3>
                <div style="text-align:center; margin-bottom:20px;">
                    ç¾åœ¨ã®ã‚¹ã‚³ã‚¢: <span id="t2_current_score" style="font-size:1.5em; font-weight:bold;">0.00</span>
                </div>
                <button onclick="judgeContinue()">åˆ¤å®šå®Ÿè¡Œ</button>
                <div id="t2_result_msg" class="msg" style="display:none;"></div>
                <div id="t2_detail" style="margin-top:15px; font-size:0.95em; line-height:1.5;"></div>
            </div>
        </div>
    </div>

    <div id="tab3" class="tab-content">
        <div class="card">
            <h3>ç¶šè¡Œå¯èƒ½æœ€å°ãƒ©ã‚¤ãƒ³ä¸€è¦§</h3>
            <div class="grid-2" style="align-items: end;">
                <label>æ¤œç´¢ã™ã‚‹å¼·åŒ–å›æ•°
                    <select id="t3_times">
                        <option value="1">1å›ç›®</option>
                        <option value="2">2å›ç›®</option>
                        <option value="3">3å›ç›®</option>
                        <option value="4">4å›ç›®</option>
                    </select>
                </label>
                <button onclick="calcLines()">ä¸€è¦§ã‚’ç”Ÿæˆ</button>
            </div>
            <div id="t3_loading" class="msg loading" style="display:none;">
                â³ è¨ˆç®—ä¸­... (ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­ã¯1åˆ†ç¨‹åº¦ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)
            </div>
            <div style="margin-top:20px; overflow-x:auto;">
                <table id="t3_table"></table>
            </div>
        </div>
    </div>

    <div id="tab4" class="tab-content">
        <div class="card">
            <h3>å˜ä½“ã‚¹ã‚³ã‚¢è¨ˆç®—</h3>
            <div id="t4_sliders" class="grid-3"></div>
            <hr>
            <div style="text-align:center;">
                <h2>åˆè¨ˆã‚¹ã‚³ã‚¢: <span id="t4_score">0.00</span></h2>
            </div>
            <button onclick="downloadCSV()">CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>

    <div id="tab5" class="tab-content">
        <div class="card">
            <h3>5é€£éŸ³éª¸ç®¡ç†</h3>
            <div id="t5_container"></div>
            <button onclick="calcEcho5()">é›†è¨ˆã™ã‚‹</button>
        </div>
        <div class="card">
            <h3>é›†è¨ˆçµæœ</h3>
            <div style="overflow-x:auto;">
                <table id="t5_table"></table>
            </div>
        </div>
    </div>

</div>

<script>
    // ============================================
    // 1. è¨­å®š & å®šæ•°
    // ============================================
    
    // â˜…ã“ã“ã‚’ Hugging Face ã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ (æœ«å°¾ã® / ã¯ç„¡ã—)
    const API_BASE = "https://okuson-chuna-backend.hf.space";

    const SUBST_DATA = {
        "cr": [6.3, 6.9, 7.5, 8.1, 8.7, 9.3, 9.9, 10.5],
        "cd": [12.6, 13.8, 15.0, 16.2, 17.4, 18.6, 19.8, 21.0],
        "atk_p": [6.4, 7.1, 7.9, 8.6, 9.4, 10.1, 10.9, 11.6],
        "dam": [6.4, 7.1, 7.9, 8.6, 9.4, 10.1, 10.9, 11.6],
        "er": [6.8, 7.6, 8.4, 9.2, 10.0, 10.8, 11.6, 12.4],
        "atk_n": [30, 40, 50, 60]
    };

    const PRESETS = {
        "ã‚«ã‚¹ã‚¿ãƒ  (æ‰‹å‹•è¨­å®š)": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—1", "d2": "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—2"},
        "ãƒªãƒ³ãƒãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "åƒå’²": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ä»‡é ": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚¬ãƒ«ãƒ–ãƒ¬ãƒ¼ãƒŠ": {"coe": [2.0, 1.0, 1.0, 0.3, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ¦ãƒ¼ãƒ": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚ªãƒ¼ã‚¬ã‚¹ã‚¿": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ•ãƒ­ãƒ¼ãƒ´ã‚¡": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 0.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ«ãƒ‘": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚·ãƒ£ã‚³ãƒ³ãƒŒ": {"coe": [2.0, 1.0, 1.0, 0.3, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚¶ãƒ³ãƒ‹ãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚«ãƒ³ã‚¿ãƒ¬ãƒ©": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ–ãƒ©ãƒ³ãƒˆ": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ•ã‚£ãƒ¼ãƒ“ãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ­ã‚³ã‚³": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚«ãƒ«ãƒ­ãƒƒã‚¿": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ãƒ„ãƒã‚­": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æŠ˜æ": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ç›¸é‡Œè¦": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "é•·é›¢": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ä»Šæ±": {"coe": [2.0, 1.0, 1.0, 0.8, 0.0, 0.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "åŸéœ–": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "å¿Œç‚": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æ°—é“ä¸»äººå…¬": {"coe": [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æ¶ˆæ»…ä¸»äººå…¬": {"coe": [2.0, 1.0, 1.0, 0.3, 0.3, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "è§£æ”¾ãƒ€ãƒ¡"},
        "å›æŠ˜ä¸»äººå…¬": {"coe": [2.0, 1.0, 1.0, 0.4, 0.3, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "è§£æ”¾ãƒ€ãƒ¡"},
        "ã‚¢ãƒ³ã‚³": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚«ã‚«ãƒ­": {"coe": [2.0, 1.0, 1.0, 0.5, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "å‡Œé™½": {"coe": [2.0, 1.0, 1.0, 0.3, 0.3, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡"},
        "ç¯ç¯": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ã‚¢ãƒ¼ãƒ«ãƒˆ": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é€šå¸¸ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ç†¾éœ": {"coe": [2.0, 1.0, 1.0, 0.5, 0.3, 1.0, 0.1], "d1": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡", "d2": "è§£æ”¾ãƒ€ãƒ¡"},
        "ãƒ¢ãƒ«ãƒˆãƒ•ã‚£ãƒ¼": {"coe": [2.0, 1.0, 1.0, 0.6, 0.0, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "ä¸¹ç‘¾": {"coe": [2.0, 1.0, 1.0, 0.4, 0.0, 1.0, 0.1], "d1": "é‡æ’ƒãƒ€ãƒ¡", "d2": "ãƒ¼ãƒ¼ãƒ¼ãƒ¼"},
        "æ•£è¯": {"coe": [2.0, 1.0, 1.0, 0.3, 0.3, 1.0, 0.1], "d1": "è§£æ”¾ãƒ€ãƒ¡", "d2": "ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡"}
    };

    let state = {
        target_score: 25,
        ave_chuna: 100.0,
        preset: PRESETS["ã‚«ã‚¹ã‚¿ãƒ  (æ‰‹å‹•è¨­å®š)"],
        coe_override: [2.0, 1.0, 1.0, 0.7, 0.0, 1.0, 0.1] // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”¨ã®ä¿‚æ•°
    };

    // ============================================
    // 2. UIæ“ä½œ
    // ============================================
    window.onload = function() {
        initCharSelect();
        updatePreset();
    };

    function switchTab(n) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab')[n-1].classList.add('active');
        document.getElementById(`tab${n}`).classList.add('active');
    }

    function initCharSelect() {
        const sel = document.getElementById('charSelect');
        Object.keys(PRESETS).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            sel.appendChild(opt);
        });
    }

    function updatePreset() {
        const name = document.getElementById('charSelect').value;
        state.preset = PRESETS[name];
        
        // ä¿‚æ•°ã‚’ã‚³ãƒ”ãƒ¼
        state.coe_override = [...state.preset.coe];
        
        renderCoeInputs(); // ä¿‚æ•°å…¥åŠ›æ¬„ã‚’æç”»
        renderAllSliders(); // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ›´æ–°
    }

    // ä¿‚æ•°å…¥åŠ›æ¬„ã®ç”Ÿæˆ
    function renderCoeInputs() {
        const container = document.getElementById('coe_inputs');
        container.innerHTML = "";
        
        const labels = getLabels(true); // å›ºå®šãƒ©ãƒ™ãƒ«åã§å–å¾—
        
        labels.forEach((lbl, i) => {
            const div = document.createElement('div');
            
            const label = document.createElement('label');
            label.style.fontSize = "0.75em";
            label.innerText = lbl;
            
            const input = document.createElement('input');
            input.type = "number";
            input.step = "0.1";
            input.className = "coe-input";
            input.value = state.coe_override[i];
            input.onchange = (e) => {
                state.coe_override[i] = parseFloat(e.target.value);
                renderAllSliders(); // æœ‰åŠ¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºåˆ‡æ›¿ãªã©ã®ãŸã‚å†æç”»
                recalcLocalScore();
            };
            
            div.appendChild(label);
            div.appendChild(input);
            container.appendChild(div);
        });
    }

    function getLabels(useStatic = false) {
        const p = state.preset;
        if(useStatic) return ["ã‚¯ãƒªç‡", "ã‚¯ãƒªãƒ€ãƒ¡", "æ”»æ’ƒ%", p.d1 || "ãƒ€ãƒ¡1", p.d2 || "ãƒ€ãƒ¡2", "å…±é³´åŠ¹ç‡", "æ”»æ’ƒå®Ÿæ•°"];
        return ["ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«", "ã‚¯ãƒªãƒ€ãƒ¡", "æ”»æ’ƒåŠ›ï¼…", p.d1 || "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—1", p.d2 || "ãƒ€ãƒ¡ã‚¢ãƒƒãƒ—2", "å…±é³´åŠ¹ç‡", "æ”»æ’ƒå®Ÿæ•°"];
    }

    function getValuesList(index) {
        const map = [
            SUBST_DATA.cr, SUBST_DATA.cd, SUBST_DATA.atk_p, 
            SUBST_DATA.dam, SUBST_DATA.dam, SUBST_DATA.er, 
            SUBST_DATA.atk_n
        ];
        return map[index];
    }

    function createSelectHTML(id, label, values) {
        let opts = `<option value="0">æœªå–å¾—</option>`;
        values.forEach(v => {
            opts += `<option value="${v}">${v}</option>`;
        });
        return `<div class="stat-group"><label class="stat-label">${label}</label><select id="${id}" onchange="recalcLocalScore()">${opts}</select></div>`;
    }

    function renderAllSliders() {
        const labels = getLabels();
        const coe = state.coe_override; // ç·¨é›†ä¸­ã®ä¿‚æ•°ã‚’ä½¿ç”¨

        let t2_html = "", t4_html = "";
        labels.forEach((lbl, i) => {
            if (coe[i] > 0) {
                const vals = getValuesList(i);
                t2_html += createSelectHTML(`t2_sub_${i}`, lbl, vals);
                t4_html += createSelectHTML(`t4_sub_${i}`, lbl, vals);
            }
        });
        document.getElementById('t2_sliders').innerHTML = `<div class="grid-3">${t2_html}</div>`;
        document.getElementById('t4_sliders').innerHTML = t4_html;

        const echoes = ["ã‚³ã‚¹ãƒˆ4", "ã‚³ã‚¹ãƒˆ3(A)", "ã‚³ã‚¹ãƒˆ3(B)", "ã‚³ã‚¹ãƒˆ1(A)", "ã‚³ã‚¹ãƒˆ1(B)"];
        let t5_html = "";
        echoes.forEach((eName, eIdx) => {
            let content = "";
            labels.forEach((lbl, i) => {
                if (coe[i] > 0) content += createSelectHTML(`t5_${eIdx}_${i}`, lbl, getValuesList(i));
            });
            t5_html += `<details><summary>${eName}</summary><div class="details-content grid-3">${content}</div></details>`;
        });
        document.getElementById('t5_container').innerHTML = t5_html;
    }

    function recalcLocalScore() {
        const coe = state.coe_override;
        let s2 = 0, s4 = 0;
        for(let i=0; i<7; i++) {
            if(coe[i]>0) {
                const el2 = document.getElementById(`t2_sub_${i}`);
                if(el2) s2 += parseFloat(el2.value) * coe[i];
                const el4 = document.getElementById(`t4_sub_${i}`);
                if(el4) s4 += parseFloat(el4.value) * coe[i];
            }
        }
        document.getElementById('t2_current_score').innerText = s2.toFixed(2);
        document.getElementById('t4_score').innerText = s4.toFixed(2);
    }

    function showTargetResult(data) {
        const area = document.getElementById('t1_result_area');
        area.style.display = 'block';
        document.getElementById('t1_msg').innerText = `ç›®æ¨™ã‚¹ã‚³ã‚¢: ${data.target_score}`;
        document.getElementById('res_tuner').innerText = Math.round(data.ave_chuna).toLocaleString();
        
        // â˜…ä¿®æ­£: ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’5000ã§å‰²ã£ã¦æ•´æ•°è¡¨ç¤º
        const recNum = Math.round(data.res_record / 5000);
        document.getElementById('res_record').innerText = recNum.toLocaleString();
        
        document.getElementById('res_body').innerText = (data.res_body > 10000) ? 'âˆ' : Math.round(data.res_body);
    }

    // ============================================
    // 3. APIé€šä¿¡
    // ============================================

    // Tab 1: ç›®æ¨™è¨ˆç®—
    async function calcTarget() {
        const limit = document.getElementById('t1_limit').value;
        const btn = document.querySelector('button[onclick="calcTarget()"]');
        btn.disabled = true; btn.innerText = "è¨ˆç®—ä¸­...";

        try {
            const res = await fetch(`${API_BASE}/api/calc_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                // ç·¨é›†å¾Œã®ä¿‚æ•°ã‚’é€ä¿¡
                body: JSON.stringify({ chuna_limit: parseFloat(limit), coe: state.coe_override })
            });
            if(!res.ok) throw new Error();
            const data = await res.json();
            
            state.target_score = data.target_score;
            state.ave_chuna = data.ave_chuna;
            document.getElementById('t1_score').value = data.target_score;
            showTargetResult(data);
        } catch(e) { alert("APIã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
        finally { btn.disabled = false; btn.innerText = "ç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—"; }
    }

    // Tab 1: ç´ æè¨ˆç®—
    async function calcResources() {
        const score = document.getElementById('t1_score').value;
        const btn = document.querySelector('button[onclick="calcResources()"]');
        btn.disabled = true; btn.innerText = "è¨ˆç®—ä¸­...";

        try {
            const res = await fetch(`${API_BASE}/api/calc_resources`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ target_score: parseInt(score), coe: state.coe_override })
            });
            if(!res.ok) throw new Error();
            const data = await res.json();
            state.target_score = data.target_score;
            state.ave_chuna = data.ave_chuna;
            showTargetResult(data);
        } catch(e) { alert("APIã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
        finally { btn.disabled = false; btn.innerText = "ç´ ææ¶ˆè²»é‡ã‚’è¨ˆç®—"; }
    }

    // Tab 2: åˆ¤å®š
    async function judgeContinue() {
        const times = document.getElementById('t2_times').value;
        let sub = [];
        for(let i=0; i<7; i++) {
            const el = document.getElementById(`t2_sub_${i}`);
            sub.push(el ? parseFloat(el.value) : 0);
        }

        try {
            const res = await fetch(`${API_BASE}/api/judge`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_score: parseInt(state.target_score),
                    current_times: parseInt(times),
                    substatus: sub,
                    ave_chuna: state.ave_chuna,
                    coe: state.coe_override
                })
            });
            const data = await res.json();
            const msgEl = document.getElementById('t2_result_msg');
            const detEl = document.getElementById('t2_detail');
            msgEl.style.display = 'block';
            msgEl.innerText = data.judgment;
            msgEl.className = 'msg ' + (data.judgment === "å¼·åŒ–æ¨å¥¨" ? "success" : data.judgment.includes("å¯èƒ½") ? "warning" : "error");

            if (data.expected_cost < 1000000) {
                const diff = state.ave_chuna - data.expected_cost;
                let comment = diff >= 0 ? `(æ–°å“ã‚ˆã‚Š ${diff.toFixed(1)} ãƒãƒ¥ãƒŠãŠå¾—)` : `(æ–°å“ã‚ˆã‚Š ${Math.abs(diff).toFixed(1)} ãƒãƒ¥ãƒŠæ)`;
                detEl.innerHTML = `ã‚´ãƒ¼ãƒ«ã¾ã§ã®æœŸå¾…ã‚³ã‚¹ãƒˆ: <b>${Math.round(data.expected_cost)}</b> ãƒãƒ¥ãƒŠ<br>${comment}`;
            } else { detEl.innerText = ""; }
        } catch(e) { alert("APIã‚¨ãƒ©ãƒ¼"); }
    }

    // Tab 3: ä¸€è¦§
    async function calcLines() {
        const times = document.getElementById('t3_times').value;
        const loader = document.getElementById('t3_loading');
        loader.style.display = 'block';
        document.getElementById('t3_table').innerHTML = "";

        try {
            const res = await fetch(`${API_BASE}/api/lines`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_score: parseInt(state.target_score),
                    search_times: parseInt(times),
                    ave_chuna: state.ave_chuna,
                    coe: state.coe_override
                })
            });
            const data = await res.json();
            loader.style.display = 'none';
            renderLineTable(data.results);
        } catch(e) { loader.style.display = 'none'; alert("APIã‚¨ãƒ©ãƒ¼"); }
    }

    function renderLineTable(rows) {
        const table = document.getElementById('t3_table');
        const labels = getLabels();
        const coe = state.coe_override;
        
        if (!rows || rows.length === 0) { table.innerHTML = "<tr><td>æ¡ä»¶ã‚’æº€ãŸã™çµ„ã¿åˆã‚ã›ãªã—</td></tr>"; return; }

        let head = "<tr>";
        labels.forEach((l, i) => { if(coe[i]>0) head += `<th>${l}</th>`; });
        head += "<th>ã‚¹ã‚³ã‚¢</th><th>ãƒãƒ¥ãƒŠ</th></tr>";
        
        rows.sort((a,b) => a.score - b.score);
        let body = "";
        rows.forEach(r => {
            let tr = "<tr>";
            r.substatus.forEach((val, i) => {
                if(coe[i]>0) tr += `<td class="${val===0?'zero-val':''}">${val.toFixed(1)}</td>`;
            });
            tr += `<td>${r.score.toFixed(1)}</td><td>${Math.round(r.chuna)}</td></tr>`;
            body += tr;
        });
        table.innerHTML = `<thead>${head}</thead><tbody>${body}</tbody>`;
    }

    function downloadCSV() {
        const coe = state.coe_override;
        const labels = getLabels();
        let csv = "ã‚µãƒ–ã‚¹ãƒ†,å€¤,ã‚¹ã‚³ã‚¢å¯„ä¸\n";
        for(let i=0; i<7; i++) {
            if(coe[i]>0) {
                const el = document.getElementById(`t4_sub_${i}`);
                const val = el ? parseFloat(el.value) : 0;
                if(val > 0) csv += `${labels[i]},${val},${(val*coe[i]).toFixed(2)}\n`;
            }
        }
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: "text/csv"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "score.csv";
        link.click();
    }

    // Tab 5: 5é€£é›†è¨ˆ
    function calcEcho5() {
        const labels = getLabels();
        const coe = state.coe_override;
        const echoes = ["ã‚³ã‚¹ãƒˆ4", "ã‚³ã‚¹ãƒˆ3(A)", "ã‚³ã‚¹ãƒˆ3(B)", "ã‚³ã‚¹ãƒˆ1(A)", "ã‚³ã‚¹ãƒˆ1(B)"];
        
        let totalStats = Array(7).fill(0);
        let totalScoreIncER = 0;
        let totalScoreExcER = 0;
        
        let echoScores = Array(5).fill(0);

        for(let e=0; e<5; e++) {
            let rowScore = 0;
            let erVal = 0;
            for(let i=0; i<7; i++) {
                if(coe[i]>0) {
                    const el = document.getElementById(`t5_${e}_${i}`);
                    const val = el ? parseFloat(el.value) : 0;
                    totalStats[i] += val;
                    rowScore += val * coe[i];
                    if(i === 5) erVal = val;
                }
            }
            echoScores[e] = rowScore;
            totalScoreIncER += rowScore;
            totalScoreExcER += (rowScore - (erVal * coe[5]));
        }

        let html = `<thead><tr><th>é …ç›®</th>`;
        echoes.forEach(e => html += `<th>${e}</th>`);
        html += `<th>åˆè¨ˆ</th></tr></thead><tbody>`;

        labels.forEach((lbl, i) => {
            if(coe[i]>0) {
                html += `<tr><td>${lbl}</td>`;
                for(let e=0; e<5; e++) {
                    const val = document.getElementById(`t5_${e}_${i}`).value;
                    html += `<td class="${val==0?'zero-val':''}">${val}</td>`;
                }
                html += `<td><b>${totalStats[i].toFixed(1)}</b></td></tr>`;
            }
        });
        
        html += `<tr class="sum-row"><td>å„éŸ³éª¸ã‚¹ã‚³ã‚¢</td>`;
        echoes.forEach((_, e) => {
            html += `<td>${echoScores[e].toFixed(1)}</td>`;
        });
        html += `<td>-</td></tr>`;

        html += `<tr style="background:#f0f0f0;"><td><b>å…¨ä½“ã‚¹ã‚³ã‚¢ (è¾¼)</b></td><td colspan="5" style="text-align:center;"></td><td><b>${totalScoreIncER.toFixed(1)}</b></td></tr>`;
        html += `<tr style="background:#f0f0f0;"><td><b>å…¨ä½“ã‚¹ã‚³ã‚¢ (æŠœ)</b></td><td colspan="5" style="font-size:0.8em; text-align:center;">(å…±é³´åŠ¹ç‡ã‚’é™¤ã)</td><td><b>${totalScoreExcER.toFixed(1)}</b></td></tr>`;
        
        html += `</tbody>`;
        document.getElementById('t5_table').innerHTML = html;
    }
</script>

</body>
</html>