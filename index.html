<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é³´æ½® éŸ³éª¸å³é¸ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root { --primary: #ff4b4b; --bg: #f0f2f6; --card-bg: #ffffff; --text: #31333f; }
        body { font-family: "Source Sans Pro", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        h1, h2, h3 { color: var(--text); }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* ã‚¿ãƒ– */
        .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
        input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        input[type="range"] { width: 100%; }
        button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 8px; text-align: right; border-bottom: 1px solid #eee; }
        th { text-align: center; background: #f8f9fa; }
        .zero-val { color: #d0d0d0; }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ */
        .slider-group { margin-bottom: 15px; }
        .val-disp { float: right; font-weight: bold; color: var(--primary); }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .msg { padding: 10px; border-radius: 4px; margin-top: 10px; font-weight: bold; text-align: center; }
        .msg.success { background: #d4edda; color: #155724; }
        .msg.warning { background: #fff3cd; color: #856404; }
        .msg.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”Š é³´æ½® éŸ³éª¸å³é¸ãƒ„ãƒ¼ãƒ« (FastAPIç‰ˆ)</h1>

    <div class="card">
        <h3>âš™ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š</h3>
        <div class="grid-3">
            <div>
                <label>ã‚­ãƒ£ãƒ©ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                <select id="charSelect" onchange="updatePreset()">
                    <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    <option value="jinshi">ä»Šæ± (ã‚¹ã‚­ãƒ«ç‰¹åŒ–)</option>
                    <option value="jiyan">å¿Œç‚ (é‡æ’ƒç‰¹åŒ–)</option>
                    <option value="changli">é•·é›¢ (ã‚¹ã‚­ãƒ«/è§£æ”¾)</option>
                    <option value="xiangli">ç›¸é‡Œè¦ (è§£æ”¾ç‰¹åŒ–)</option>
                    <option value="tsubaki">ãƒ„ãƒã‚­ (é€šå¸¸ç‰¹åŒ–)</option>
                    <option value="verina">ãƒ´ã‚§ãƒªãƒ¼ãƒŠ (ãƒ’ãƒ¼ãƒ©ãƒ¼)</option>
                </select>
            </div>
            <div style="grid-column: span 2; display: flex; align-items: center; font-size: 0.8em; color: #666;">
                â€»ä¿‚æ•°ã¯ãƒ—ãƒªã‚»ãƒƒãƒˆã«å¿œã˜ã¦è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™ï¼ˆAPIã«é€ä¿¡ã•ã‚Œã¾ã™ï¼‰
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(1)">â‘  ç›®æ¨™è¨­å®š</div>
        <div class="tab" onclick="switchTab(2)">â‘¡ ç¶šè¡Œåˆ¤å®š</div>
        <div class="tab" onclick="switchTab(3)">â‘¢ æœ€å°ãƒ©ã‚¤ãƒ³</div>
        <div class="tab" onclick="switchTab(4)">â‘£ å˜ä½“ã‚¹ã‚³ã‚¢</div>
        <div class="tab" onclick="switchTab(5)">â‘¤ 5é€£ç®¡ç†</div>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="grid-2">
            <div class="card">
                <h3>ç›®æ¨™ã‚¹ã‚³ã‚¢ç®—å‡º</h3>
                <label>ä½¿ç”¨å¯èƒ½ãƒãƒ¥ãƒŠä¸Šé™: <input type="number" id="t1_limit" value="500"></label>
                <button onclick="calcTarget()">è¨ˆç®—ã™ã‚‹</button>
                <div id="t1_res_calc" class="msg" style="display:none;"></div>
            </div>
            <div class="card">
                <h3>å¿…è¦ç´ æè¨ˆç®—</h3>
                <label>ç›®æ¨™ã‚¹ã‚³ã‚¢å…¥åŠ›: <input type="number" id="t1_score" value="25"></label>
                <button onclick="calcResources()">ç´ ææ¶ˆè²»é‡ã‚’è¨ˆç®—</button>
            </div>
        </div>
        <div class="card" id="t1_resources" style="display:none;">
            <h3>ğŸ“Š æƒ³å®šæ¶ˆè²»ãƒªã‚½ãƒ¼ã‚¹</h3>
            <div class="grid-3" style="text-align: center;">
                <div><h4>ãƒãƒ¥ãƒŠ</h4><span id="res_tuner" style="font-size: 1.5em; font-weight: bold;"></span></div>
                <div><h4>ãƒ¬ã‚³ãƒ¼ãƒ‰</h4><span id="res_record" style="font-size: 1.5em; font-weight: bold;"></span></div>
                <div><h4>éŸ³éª¸ç´ ä½“</h4><span id="res_body" style="font-size: 1.5em; font-weight: bold;"></span></div>
            </div>
        </div>
    </div>

    <div id="tab2" class="tab-content">
        <div class="grid-2">
            <div class="card">
                <h3>ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                <label>ç¾åœ¨ã®å¼·åŒ–å›æ•° (0-4): <input type="range" id="t2_times" min="0" max="4" value="1" oninput="document.getElementById('t2_times_val').innerText=this.value"></label>
                <div style="text-align:right; margin-bottom:10px;">å›æ•°: <span id="t2_times_val">1</span></div>
                <div id="t2_sliders"></div> </div>
            <div class="card">
                <h3>åˆ¤å®šçµæœ</h3>
                <div style="font-size: 1.2em; text-align: center; margin-bottom: 20px;">
                    ç¾åœ¨ã‚¹ã‚³ã‚¢: <span id="t2_score" style="font-weight: bold; color: var(--primary);">0.0</span>
                </div>
                <button onclick="judgeContinue()">åˆ¤å®šå®Ÿè¡Œ</button>
                <div id="t2_result" class="msg" style="display:none;"></div>
                <div id="t2_detail" style="margin-top:10px; font-size: 0.9em;"></div>
            </div>
        </div>
    </div>

    <div id="tab3" class="tab-content">
        <div class="card">
            <h3>ç¶šè¡Œå¯èƒ½æœ€å°ãƒ©ã‚¤ãƒ³ä¸€è¦§</h3>
            <label>æ¤œç´¢ã™ã‚‹å¼·åŒ–å›æ•°: 
                <select id="t3_times" style="width: auto;">
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                </select>
            </label>
            <button onclick="calcLines()">ä¸€è¦§ã‚’ç”Ÿæˆ</button>
            <div id="t3_loading" style="display:none; text-align:center; padding:20px;">è¨ˆç®—ä¸­...</div>
            <div style="margin-top: 20px; overflow-x: auto;">
                <table id="t3_table"></table>
            </div>
        </div>
    </div>

    <div id="tab4" class="tab-content">
        <div class="card">
            <h3>ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¥åŠ›</h3>
            <div id="t4_sliders" class="grid-3"></div> <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <div style="text-align: center;">
                <h2>åˆè¨ˆã‚¹ã‚³ã‚¢: <span id="t4_score">0.00</span></h2>
            </div>
            <button onclick="downloadCSV()">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>

    <div id="tab5" class="tab-content">
        <div class="card">
            <h3>5é€£éŸ³éª¸å…¥åŠ›</h3>
            <div id="t5_container"></div> <button onclick="calcEcho5()">é›†è¨ˆã™ã‚‹</button>
        </div>
        <div class="card">
            <h3>é›†è¨ˆçµæœ</h3>
            <div style="overflow-x: auto;">
                <table id="t5_table"></table>
            </div>
        </div>
    </div>

</div>

<script>
    // --- å®šæ•°ãƒ‡ãƒ¼ã‚¿ (Pythonå´ã¨åŒã˜ã‚‚ã®) ---
    const SUBST_DATA = {
        "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«": [6.3, 6.9, 7.5, 8.1, 8.7, 9.3, 9.9, 10.5],
        "ã‚¯ãƒªãƒ€ãƒ¡": [12.6, 13.8, 15.0, 16.2, 17.4, 18.6, 19.8, 21.0],
        "æ”»æ’ƒåŠ›ï¼…": [6.4, 7.1, 7.9, 8.6, 9.4, 10.1, 10.9, 11.6],
        "å…±é³´åŠ¹ç‡": [6.8, 7.6, 8.4, 9.2, 10.0, 10.8, 11.6, 12.4],
        "æ”»æ’ƒå®Ÿæ•°": [30, 40, 50, 60],
        "ãƒ€ãƒ¡UP": [6.4, 7.1, 7.9, 8.6, 9.4, 10.1, 10.9, 11.6]
    };

    const PRESETS = {
        "custom": { coe: [2.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.1], d1: "ãƒ€ãƒ¡1", d2: "ãƒ€ãƒ¡2" },
        "jinshi": { coe: [2.0, 1.0, 0.8, 1.0, 0.0, 0.2, 0.05], d1: "ã‚¹ã‚­ãƒ«", d2: "ãã®ä»–" },
        "jiyan": { coe: [2.0, 1.0, 0.8, 1.0, 0.0, 0.2, 0.05], d1: "é‡æ’ƒ", d2: "è§£æ”¾" },
        "changli": { coe: [2.0, 1.0, 0.8, 1.0, 1.0, 0.2, 0.05], d1: "ã‚¹ã‚­ãƒ«", d2: "è§£æ”¾" },
        "xiangli": { coe: [2.0, 1.0, 0.8, 1.0, 0.0, 0.2, 0.05], d1: "è§£æ”¾", d2: "ã‚¹ã‚­ãƒ«" },
        "tsubaki": { coe: [2.0, 1.0, 0.8, 1.0, 0.0, 0.1, 0.05], d1: "é€šå¸¸", d2: "ã‚¹ã‚­ãƒ«" },
        "verina": { coe: [0.0, 0.0, 1.0, 0.0, 0.0, 2.0, 0.1], d1: "å›å¾©", d2: "ä¸è¦" }
    };

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
    let currentState = {
        target_score: 25,
        ave_chuna: 100,
        preset: PRESETS["custom"]
    };

    // --- åˆæœŸåŒ– ---
    window.onload = () => {
        updatePreset();
        renderSliders();
    };

    function switchTab(n) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab')[n-1].classList.add('active');
        document.getElementById(`tab${n}`).classList.add('active');
    }

    function updatePreset() {
        const key = document.getElementById('charSelect').value;
        currentState.preset = PRESETS[key];
        renderSliders();
    }

    function getLabels() {
        const p = currentState.preset;
        return ["ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«", "ã‚¯ãƒªãƒ€ãƒ¡", "æ”»æ’ƒåŠ›ï¼…", p.d1, p.d2, "å…±é³´åŠ¹ç‡", "æ”»æ’ƒå®Ÿæ•°"];
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
    function createSliderHTML(id_prefix, idx, label, values) {
        // datalistç”¨ã®ID
        const listId = `${id_prefix}_list_${idx}`;
        let options = values.map(v => `<option value="${v}"></option>`).join('');
        
        // input type=range ã¯ä¸é€£ç¶šãªå€¤ã‚’ã¨ã‚Œãªã„ã®ã§ã€stepæ“ä½œã§ã¯ãªã
        // é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ç®¡ç†ã™ã‚‹ã‹ã€ç°¡æ˜“çš„ã« select ã‚’ä½¿ã†ã®ãŒå®‰å…¨
        // ã“ã“ã§ã¯UIã®å†ç¾æ€§ã‚’é‡è¦–ã—ã¦ select ã«ã—ã¾ã™
        let selectOpts = `<option value="0">æœªå–å¾—</option>` + 
                         values.map(v => `<option value="${v}">${v}</option>`).join('');

        return `
            <div class="slider-group">
                <label>${label}</label>
                <select id="${id_prefix}_${idx}" onchange="calcLocalScore('${id_prefix}')">
                    ${selectOpts}
                </select>
            </div>`;
    }

    function renderSliders() {
        const labels = getLabels();
        const lists = [
            SUBST_DATA["ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«"], SUBST_DATA["ã‚¯ãƒªãƒ€ãƒ¡"], SUBST_DATA["æ”»æ’ƒåŠ›ï¼…"],
            SUBST_DATA["ãƒ€ãƒ¡UP"], SUBST_DATA["ãƒ€ãƒ¡UP"], SUBST_DATA["å…±é³´åŠ¹ç‡"], SUBST_DATA["æ”»æ’ƒå®Ÿæ•°"]
        ];
        const coe = currentState.preset.coe;

        // Tab2
        let t2_html = '<div class="grid-3">';
        labels.forEach((lbl, i) => {
            if (coe[i] > 0) t2_html += createSliderHTML('t2_sub', i, lbl, lists[i]);
        });
        document.getElementById('t2_sliders').innerHTML = t2_html + '</div>';

        // Tab4
        let t4_html = '';
        labels.forEach((lbl, i) => {
            if (coe[i] > 0) t4_html += createSliderHTML('t4_sub', i, lbl, lists[i]);
        });
        document.getElementById('t4_sliders').innerHTML = t4_html;

        // Tab5 (5å€‹åˆ†)
        let t5_html = '';
        const echoes = ["ã‚³ã‚¹ãƒˆ4", "ã‚³ã‚¹ãƒˆ3(A)", "ã‚³ã‚¹ãƒˆ3(B)", "ã‚³ã‚¹ãƒˆ1(A)", "ã‚³ã‚¹ãƒˆ1(B)"];
        echoes.forEach((name, eIdx) => {
            t5_html += `<details><summary style="cursor:pointer; font-weight:bold; padding:10px; background:#f8f9fa; margin-bottom:5px;">${name}</summary><div class="grid-3" style="padding:10px;">`;
            labels.forEach((lbl, i) => {
                if (coe[i] > 0) t5_html += createSliderHTML(`t5_${eIdx}_sub`, i, lbl, lists[i]);
            });
            t5_html += `</div></details>`;
        });
        document.getElementById('t5_container').innerHTML = t5_html;
    }

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®ç°¡æ˜“ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    function calcLocalScore(prefix) {
        const coe = currentState.preset.coe;
        let score = 0;
        for (let i = 0; i < 7; i++) {
            if (coe[i] > 0) {
                const el = document.getElementById(`${prefix}_${i}`);
                if (el) score += parseFloat(el.value) * coe[i];
            }
        }
        if (prefix === 't2_sub') document.getElementById('t2_score').innerText = score.toFixed(2);
        if (prefix === 't4_sub') document.getElementById('t4_score').innerText = score.toFixed(2);
    }

    // --- APIé€£æº ---
    const API_BASE = "http://localhost:8000"; // æœ¬ç•ªæ™‚ã¯å¤‰æ›´

    async function calcTarget() {
        const limit = document.getElementById('t1_limit').value;
        const msg = document.getElementById('t1_res_calc');
        msg.style.display = 'block'; msg.className = 'msg'; msg.innerText = 'è¨ˆç®—ä¸­...';

        try {
            const res = await fetch(`${API_BASE}/api/calc_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chuna_limit: parseFloat(limit), coe: currentState.preset.coe })
            });
            const data = await res.json();
            currentState.target_score = data.target_score;
            currentState.ave_chuna = data.ave_chuna;
            
            // å…¥åŠ›æ¬„ã«åæ˜ 
            document.getElementById('t1_score').value = data.target_score;
            
            msg.className = 'msg success';
            msg.innerText = `æ¨å¥¨ç›®æ¨™ã‚¹ã‚³ã‚¢: ${data.target_score}`;
            displayResources(data);
        } catch(e) {
            msg.className = 'msg error'; msg.innerText = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        }
    }

    function displayResources(data) {
        document.getElementById('t1_resources').style.display = 'block';
        document.getElementById('res_tuner').innerText = Math.round(data.ave_chuna).toLocaleString();
        document.getElementById('res_record').innerText = Math.round(data.res_record).toLocaleString();
        document.getElementById('res_body').innerText = (data.res_body > 10000) ? 'âˆ' : Math.round(data.res_body);
    }

    async function judgeContinue() {
        const times = document.getElementById('t2_times').value;
        const sub = [];
        for(let i=0; i<7; i++) {
            const el = document.getElementById(`t2_sub_${i}`);
            sub.push(el ? parseFloat(el.value) : 0);
        }

        try {
            const res = await fetch(`${API_BASE}/api/judge`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_score: currentState.target_score,
                    current_times: parseInt(times),
                    substatus: sub,
                    ave_chuna: currentState.ave_chuna,
                    coe: currentState.preset.coe
                })
            });
            const data = await res.json();
            const resDiv = document.getElementById('t2_result');
            resDiv.style.display = 'block';
            resDiv.innerText = data.judgment;
            
            if (data.judgment.includes("æ¨å¥¨")) resDiv.className = 'msg success';
            else if (data.judgment.includes("å¯èƒ½")) resDiv.className = 'msg warning';
            else resDiv.className = 'msg error';

            if (data.expected_cost < 1000000) {
                document.getElementById('t2_detail').innerText = `ã‚´ãƒ¼ãƒ«ã¾ã§ã®æœŸå¾…ã‚³ã‚¹ãƒˆ: ${Math.round(data.expected_cost)} ãƒãƒ¥ãƒŠ`;
            }
        } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); }
    }

    async function calcLines() {
        const times = document.getElementById('t3_times').value;
        document.getElementById('t3_loading').style.display = 'block';
        document.getElementById('t3_table').innerHTML = '';

        try {
            const res = await fetch(`${API_BASE}/api/lines`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_score: currentState.target_score,
                    search_times: parseInt(times),
                    ave_chuna: currentState.ave_chuna,
                    coe: currentState.preset.coe
                })
            });
            const data = await res.json();
            document.getElementById('t3_loading').style.display = 'none';
            renderTable('t3_table', data.results, getLabels());
        } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); document.getElementById('t3_loading').style.display = 'none'; }
    }

    function renderTable(tableId, rows, labels) {
        const table = document.getElementById(tableId);
        const coe = currentState.preset.coe;
        
        // Header
        let thead = '<tr>';
        labels.forEach((lbl, i) => { if(coe[i]>0) thead += `<th>${lbl}</th>`; });
        thead += '<th>ã‚¹ã‚³ã‚¢</th><th>ãƒãƒ¥ãƒŠ</th></tr>';
        
        let tbody = '';
        // Sort by score
        rows.sort((a,b) => a.score - b.score);
        
        rows.forEach(r => {
            let tr = '<tr>';
            r.substatus.forEach((val, i) => {
                if(coe[i]>0) tr += `<td class="${val==0?'zero-val':''}">${val.toFixed(1)}</td>`;
            });
            tr += `<td>${r.score.toFixed(1)}</td><td>${Math.round(r.chuna)}</td></tr>`;
            tbody += tr;
        });
        table.innerHTML = thead + tbody;
    }

    // 5é€£é›†è¨ˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿ã§å®Œçµå¯èƒ½ï¼‰
    function calcEcho5() {
        const coe = currentState.preset.coe;
        const labels = getLabels();
        const echoes = ["ã‚³ã‚¹ãƒˆ4", "ã‚³ã‚¹ãƒˆ3(A)", "ã‚³ã‚¹ãƒˆ3(B)", "ã‚³ã‚¹ãƒˆ1(A)", "ã‚³ã‚¹ãƒˆ1(B)"];
        
        // ãƒ‡ãƒ¼ã‚¿åé›† [echoIdx][statIdx]
        let data = [];
        let totalStats = Array(7).fill(0);
        let totalScoreIncl = 0;
        let totalScoreExcl = 0;

        for(let e=0; e<5; e++) {
            let rowScore = 0;
            let rowVals = [];
            for(let i=0; i<7; i++) {
                let val = 0;
                if(coe[i]>0) {
                    const el = document.getElementById(`t5_${e}_sub_${i}`);
                    val = el ? parseFloat(el.value) : 0;
                }
                rowVals.push(val);
                totalStats[i] += val;
                rowScore += val * coe[i];
            }
            totalScoreIncl += rowScore;
            // å…±é³´åŠ¹ç‡(idx 5)æŠœã
            totalScoreExcl += (rowScore - rowVals[5]*coe[5]);
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ (ç¸¦æ¨ªå¤‰æ›)
        let html = '<tr><th>é …ç›®</th>';
        echoes.forEach(e => html += `<th>${e}</th>`);
        html += '<th>åˆè¨ˆ</th></tr>';

        labels.forEach((lbl, i) => {
            if(coe[i] > 0) {
                html += `<tr><td>${lbl}</td>`;
                for(let e=0; e<5; e++) {
                    const val = document.getElementById(`t5_${e}_sub_${i}`).value;
                    html += `<td class="${val==0?'zero-val':''}">${val}</td>`;
                }
                html += `<td>${totalStats[i].toFixed(1)}</td></tr>`;
            }
        });

        html += `<tr style="background:#f0f0f0; font-weight:bold;"><td>ã‚¹ã‚³ã‚¢(è¾¼)</td><td colspan="5" style="text-align:center;"></td><td>${totalScoreIncl.toFixed(1)}</td></tr>`;
        html += `<tr style="background:#f0f0f0; font-weight:bold;"><td>ã‚¹ã‚³ã‚¢(æŠœ)</td><td colspan="5" style="text-align:center;"></td><td>${totalScoreExcl.toFixed(1)}</td></tr>`;

        document.getElementById('t5_table').innerHTML = html;
    }

    function downloadCSV() {
        const coe = currentState.preset.coe;
        const labels = getLabels();
        let csv = "ã‚µãƒ–ã‚¹ãƒ†,å€¤,ã‚¹ã‚³ã‚¢å¯„ä¸\n";
        for(let i=0; i<7; i++) {
            if(coe[i]>0) {
                const val = parseFloat(document.getElementById(`t4_sub_${i}`).value);
                if(val > 0) {
                    csv += `${labels[i]},${val},${(val*coe[i]).toFixed(2)}\n`;
                }
            }
        }
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: "text/csv"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "score.csv";
        a.click();
    }
</script>

</body>
</html>